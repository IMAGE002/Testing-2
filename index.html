<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Discover Almaty - Globe View</title>
  <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.9.0/maptiler-sdk.umd.min.js"></script>
  <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.9.0/maptiler-sdk.css" rel="stylesheet"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');
    
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #map { 
      position: absolute; 
      top: 0; 
      bottom: 0; 
      width: 100%; 
    }

    /* Header from Script 2 */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(10, 14, 39, 0) 100%);
      padding: 25px 30px;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }

    .header > * {
      pointer-events: auto;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo::before {
      content: 'üèîÔ∏è';
      font-size: 28px;
    }

    .stats {
      display: flex;
      gap: 30px;
      color: #fff;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #00d4ff;
    }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.7;
      letter-spacing: 1px;
    }

    /* Sidebar from Script 2 */
    .sidebar {
      position: absolute;
      left: 30px;
      top: 120px;
      bottom: 30px;
      width: 320px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 999;
      padding: 25px;
      overflow-y: auto;
      transition: transform 0.3s ease;
    }

    .sidebar::-webkit-scrollbar {
      display: none;
    }
    
    .sidebar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .sidebar-title {
      font-size: 22px;
      font-weight: 700;
      color: #0a0e27;
      margin-bottom: 8px;
    }

    .sidebar-subtitle {
      font-size: 13px;
      color: #666;
      margin-bottom: 25px;
    }

    .location-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    .location-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
      border-radius: 50%;
      transform: translate(30%, -30%);
    }

    .location-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .location-card.green {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .location-card.orange {
      background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
    }

    .location-card.blue {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .location-card.yellow {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .location-icon {
      font-size: 32px;
      margin-bottom: 10px;
      display: block;
    }

    .location-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .location-desc {
      font-size: 13px;
      opacity: 0.95;
      line-height: 1.4;
    }

    /* Toggle Button */
    .toggle-ui {
      position: absolute;
      top: 150px;
      left: 360px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: none;
      width: 40px;
      height: 80px;
      border-radius: 0 12px 12px 0;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
      z-index: 998;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #667eea;
      font-weight: 600;
    }

    .toggle-ui:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 6px 0 24px rgba(0, 0, 0, 0.2);
      width: 45px;
    }

    .sidebar.hidden {
      transform: translateX(-380px);
    }

    .toggle-ui.sidebar-hidden {
      left: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    /* Location Popup from Script 3 */
    .location-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 10001;
      max-width: 400px;
      display: none;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        transform: translate(-50%, -50%) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }
    
    .location-popup.show {
      display: block;
    }
    
    .location-popup h3 {
      margin: 0 0 15px 0;
      font-size: 20px;
      color: #202124;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .location-popup p {
      margin: 0 0 20px 0;
      font-size: 14px;
      color: #5f6368;
      line-height: 1.6;
    }
    
    .location-popup-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .location-popup button {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .popup-btn-block {
      background: #f1f3f4;
      color: #202124;
    }
    
    .popup-btn-block:hover {
      background: #e8eaed;
    }
    
    .popup-btn-allow {
      background: #667eea;
      color: white;
    }
    
    .popup-btn-allow:hover {
      background: #5568d3;
    }

    /* Location Button from Script 3 */
    .location-button-container {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      transition: all 0.5s ease;
    }
    
    .location-button-container svg {
      width: 332px;
      height: 150px;
      cursor: pointer;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
    }

    @media (max-width: 768px) {
      .stats {
        display: none;
      }

      .sidebar {
        width: 280px;
      }

      .location-button-container svg {
        width: 280px;
        height: 120px;
      }
    }

    /* Adjust MapTiler controls position */
    .maplibregl-ctrl-top-right {
      top: 100px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Header from Script 2 -->
  <div class="header">
    <div class="logo">Discover Almaty</div>
    <div class="stats">
      <div class="stat-item">
        <div class="stat-value">~2M</div>
        <div class="stat-label">Population</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">1,691m</div>
        <div class="stat-label">Max Altitude</div>
      </div>
      <div class="stat-item">
        <div class="stat-value">5</div>
        <div class="stat-label">Key Locations</div>
      </div>
    </div>
  </div>

  <!-- Toggle Button -->
  <button class="toggle-ui" onclick="toggleUI()" id="toggleBtn">‚óÄ</button>

  <!-- Sidebar from Script 2 -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-title">Explore Almaty</div>
    <div class="sidebar-subtitle">Discover the cultural and natural wonders of Kazakhstan's largest city</div>

    <div class="location-card" onclick="flyTo([77.0515, 43.1630], 14)">
      <span class="location-icon">‚õ∏Ô∏è</span>
      <div class="location-name">Medeu</div>
      <div class="location-desc">World's highest mountain ice skating rink at 1,691m altitude. Famous for speed skating records.</div>
    </div>

    <div class="location-card green" onclick="flyTo([76.9770, 43.2300], 15)">
      <span class="location-icon">üóº</span>
      <div class="location-name">Kok-Tobe</div>
      <div class="location-desc">Iconic TV tower and observation deck offering panoramic city views from 1,100m elevation.</div>
    </div>

    <div class="location-card orange" onclick="flyTo([76.9565, 43.2582], 16)">
      <span class="location-icon">üèõÔ∏è</span>
      <div class="location-name">Panfilov Park</div>
      <div class="location-desc">Historic park featuring the stunning Zenkov Cathedral, one of the world's tallest wooden buildings.</div>
    </div>

    <div class="location-card blue" onclick="flyTo([76.9560, 43.2640], 16)">
      <span class="location-icon">üè™</span>
      <div class="location-name">Green Bazaar</div>
      <div class="location-desc">Traditional market operating since 1875. Experience authentic Kazakh culture and cuisine.</div>
    </div>

    <div class="location-card yellow" onclick="flyTo([77.0808, 43.1281], 13)">
      <span class="location-icon">‚õ∑Ô∏è</span>
      <div class="location-name">Shymbulak</div>
      <div class="location-desc">Premier ski resort at 2,200m altitude with world-class slopes and stunning mountain scenery.</div>
    </div>
  </div>

  <!-- Location Popup from Script 3 -->
  <div class="location-popup" id="locationPopup">
    <h3>üåç Know your location</h3>
    <p>This site wants to use your location to show your position and provide personalized recommendations</p>
    <div class="location-popup-buttons">
      <button class="popup-btn-block" onclick="handleLocationBlock()">Block</button>
      <button class="popup-btn-allow" onclick="handleLocationAllow()">Allow</button>
    </div>
  </div>

  <!-- Location Button from Script 3 -->
  <div class="location-button-container">
    <svg id="locationButton" width="332" height="150" viewBox="0 0 332 150" fill="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="filter0_d" x="0" y="43.2548" width="329" height="106" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
          <feFlood flood-opacity="0" result="BackgroundImageFix"/>
          <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
          <feOffset dy="4"/>
          <feGaussianBlur stdDeviation="2"/>
          <feComposite in2="hardAlpha" operator="out"/>
          <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
          <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow"/>
          <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape"/>
        </filter>
        <filter id="filter1_d" x="39" y="40.2548" width="49" height="106" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
          <feFlood flood-opacity="0" result="BackgroundImageFix"/>
          <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
          <feOffset dy="1"/>
          <feGaussianBlur stdDeviation="2"/>
          <feComposite in2="hardAlpha" operator="out"/>
          <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
          <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow"/>
          <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow" result="shape"/>
        </filter>
      </defs>
      
      <!-- RED PIN GROUP -->
      <g id="redPin">
        <path d="M284.782 0.400566C270.822 2.68859 260.999 16.8223 263.367 31.2703C265.847 46.3994 282.085 59.6255 293.084 68.989C293.127 69.0269 294.895 70.4801 296.73 70.1793L296.893 70.1526C298.729 69.8517 299.929 67.9119 299.959 67.8621C306.938 56.2437 316.813 37.3545 314.444 22.8988C312.075 8.45086 300.855 -2.23383 284.782 0.400566ZM296.32 65.4513C296.258 65.5399 296.164 65.6429 296.079 65.7296C295.97 65.6768 295.849 65.607 295.758 65.5434L294.43 64.4127C284.006 55.5612 269.732 43.4401 267.623 30.5727C265.644 18.4967 273.83 6.6781 285.497 4.76574C300.031 2.38372 308.369 12.5061 310.187 23.5965C311.788 33.3649 307.122 47.4481 296.32 65.4513ZM286.779 13.6483C279.728 14.8041 274.972 21.6061 276.157 28.84C277.343 36.0738 284.021 41.0017 291.073 39.8459C298.125 38.6901 302.881 31.888 301.695 24.6542C300.51 17.4204 293.831 12.4925 286.779 13.6483ZM290.358 35.4796C285.664 36.2489 281.089 32.8783 280.3 28.0623C279.511 23.2474 282.688 18.7039 287.381 17.9346C292.078 17.1647 296.536 20.4569 297.325 25.2718C298.117 30.0875 295.055 34.7098 290.358 35.4796Z" fill="#AD2831"/>
        <g filter="url(#filter0_d)">
          <rect x="4" y="43.2548" width="321" height="98" rx="49" fill="#AD2831"/>
        </g>
        <g filter="url(#filter1_d)">
          <path d="M60.9482 43.2548H84L67 141.255H55H49.5L43 140.255L60.9482 43.2548Z" fill="white" fill-opacity="0.34" shape-rendering="crispEdges"/>
        </g>
        <text x="145" y="87" font-family="Jua, sans-serif" font-size="28" font-weight="Regular" fill="black" text-anchor="middle" dominant-baseline="middle">Search For Best</text>
        <text x="137" y="105" font-family="Jua, sans-serif" font-size="16" font-weight="Regular" fill="black" fill-opacity="0.7" text-anchor="middle" dominant-baseline="middle">Allow Us To See Your Location</text>
        
        <path d="M292.047 72.2078C288.088 68.2466 282.864 66.2518 277.676 66.2548C272.487 66.2518 267.264 68.2466 263.306 72.2078C259.345 76.1661 257.348 81.3908 257.354 86.5768C257.35 90.2 258.346 93.8278 260.278 97.0428L250.437 106.884C248.521 108.799 248.521 111.904 250.437 113.819C252.351 115.735 255.457 115.735 257.371 113.819L267.213 103.977C270.427 105.91 274.056 106.905 277.676 106.9C282.864 106.905 288.088 104.91 292.047 100.949C296.006 96.9904 298.003 91.767 297.998 86.5767C298.004 81.3908 296.006 76.1661 292.047 72.2078ZM286.497 95.4009C284.052 97.8443 280.882 99.0496 277.676 99.0556C274.47 99.0496 271.302 97.8444 268.854 95.4009C266.41 92.953 265.205 89.7843 265.199 86.5768C265.205 83.3722 266.41 80.2021 268.854 77.7556C271.301 75.3122 274.47 74.1069 277.676 74.1009C280.882 74.1069 284.052 75.3121 286.499 77.7556C288.942 80.2021 290.148 83.3722 290.154 86.5768C290.148 89.7844 288.942 92.953 286.497 95.4009Z" fill="black"/>
        <g opacity="1">
          <path d="M310.55 52.7548L319.487 43.6454C320.787 42.3204 320.787 40.3329 319.487 39.0079C319 38.3454 318.188 37.8485 317.375 37.8485C316.562 37.8485 315.75 38.1798 315.1 38.8423L306 48.1173L297.062 39.0079C295.762 37.6829 293.65 37.6829 292.512 39.0079C291.862 39.5048 291.375 40.3329 291.375 41.3266C291.375 42.3204 291.7 42.9829 292.35 43.6454L301.288 52.7548L292.35 61.8641C291.862 62.5266 291.375 63.3548 291.375 64.3485C291.375 65.1766 291.7 66.0048 292.35 66.6673C293 67.3298 293.812 67.661 294.625 67.661C295.438 67.661 296.25 67.3298 296.9 66.6673L305.837 57.5579L314.775 66.6673C316.075 67.9923 318.188 67.9923 319.325 66.6673C320.625 65.3423 320.625 63.1891 319.325 62.0298L310.55 52.7548Z" fill="#931F27"/>
        </g>
      </g>
      
      <!-- GREEN PIN GROUP -->
      <g id="greenPin" style="opacity: 0;">
        <path d="M284.782 0.400566C270.822 2.68859 260.999 16.8223 263.367 31.2703C265.847 46.3994 282.085 59.6255 293.084 68.989C293.127 69.0269 294.895 70.4801 296.73 70.1793L296.893 70.1526C298.729 69.8517 299.929 67.9119 299.959 67.8621C306.938 56.2437 316.813 37.3545 314.444 22.8988C312.075 8.45086 300.855 -2.23383 284.782 0.400566ZM296.32 65.4513C296.258 65.5399 296.164 65.6429 296.079 65.7296C295.97 65.6768 295.849 65.607 295.758 65.5434L294.43 64.4127C284.006 55.5612 269.732 43.4401 267.623 30.5727C265.644 18.4967 273.83 6.6781 285.497 4.76574C300.031 2.38372 308.369 12.5061 310.187 23.5965C311.788 33.3649 307.122 47.4481 296.32 65.4513ZM286.779 13.6483C279.728 14.8041 274.972 21.6061 276.157 28.84C277.343 36.0738 284.021 41.0017 291.073 39.8459C298.125 38.6901 302.881 31.888 301.695 24.6542C300.51 17.4204 293.831 12.4925 286.779 13.6483ZM290.358 35.4796C285.664 36.2489 281.089 32.8783 280.3 28.0623C279.511 23.2474 282.688 18.7039 287.381 17.9346C292.078 17.1647 296.536 20.4569 297.325 25.2718C298.117 30.0875 295.055 34.7098 290.358 35.4796Z" fill="#65E983"/>
        <g filter="url(#filter0_d)">
          <rect x="4" y="43.2548" width="321" height="98" rx="49" fill="#65E983"/>
        </g>
        <g filter="url(#filter1_d)">
          <path d="M60.9482 43.2548H84L67 141.255H55H49.5L43 140.255L60.9482 43.2548Z" fill="white" fill-opacity="0.34" shape-rendering="crispEdges"/>
        </g>
        <text x="145" y="87" font-family="Jua, sans-serif" font-size="28" font-weight="Regular" fill="black" text-anchor="middle" dominant-baseline="middle">Search</text>
        <text x="137" y="105" font-family="Jua, sans-serif" font-size="18" font-weight="Regular" fill="black" fill-opacity="0.7" text-anchor="middle" dominant-baseline="middle">Find The Best In Your City</text>
        
        <path d="M292.047 72.2078C288.088 68.2466 282.864 66.2518 277.676 66.2548C272.487 66.2518 267.264 68.2466 263.306 72.2078C259.345 76.1661 257.348 81.3908 257.354 86.5768C257.35 90.2 258.346 93.8278 260.278 97.0428L250.437 106.884C248.521 108.799 248.521 111.904 250.437 113.819C252.351 115.735 255.457 115.735 257.371 113.819L267.213 103.977C270.427 105.91 274.056 106.905 277.676 106.9C282.864 106.905 288.088 104.91 292.047 100.949C296.006 96.9904 298.003 91.767 297.998 86.5767C298.004 81.3908 296.006 76.1661 292.047 72.2078ZM286.497 95.4009C284.052 97.8443 280.882 99.0496 277.676 99.0556C274.47 99.0496 271.302 97.8444 268.854 95.4009C266.41 92.953 265.205 89.7843 265.199 86.5768C265.205 83.3722 266.41 80.2021 268.854 77.7556C271.301 75.3122 274.47 74.1069 277.676 74.1009C280.882 74.1069 284.052 75.3121 286.499 77.7556C288.942 80.2021 290.148 83.3722 290.154 86.5768C290.148 89.7844 288.942 92.953 286.497 95.4009Z" fill="black"/>
        <path d="M298.157 45.804L306.044 54.28L325.893 36.22" stroke="#65E983" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M298.157 45.804L306.044 54.28L325.893 36.22" stroke="black" stroke-opacity="0.2" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
      </g>
    </svg>
  </div>

  <script>
    let map;
    let locationPermissionGranted = false;
    let userMarker = null;

    // Script 1: Initialize MapTiler Globe Map (UNCHANGED)
    document.addEventListener('DOMContentLoaded', function () {
      // Set your MapTiler API key
      maptilersdk.config.apiKey = 'duDibeLwnR7FadzBmNO8';
      
      // Initialize map with your custom style (EXACTLY AS SCRIPT 1)
      map = new maptilersdk.Map({
        container: 'map',
        style: 'https://api.maptiler.com/maps/019acf94-b488-7ec9-94bd-bf1f63086769/style.json?key=duDibeLwnR7FadzBmNO8',
        center: [-52.47437, -13.29009],
        zoom: 1.2,
        projection: 'mercator' // start in Mercator
      });
      
      // Controls (EXACTLY AS SCRIPT 1)
      map.addControl(new maptilersdk.NavigationControl(), 'top-right');
      map.addControl(new maptilersdk.MaptilerProjectionControl(), 'top-right'); // toggle Mercator/Globe
      map.addControl(new maptilersdk.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true
      }), 'top-right');
      map.addControl(new maptilersdk.ScaleControl(), 'bottom-left');
      
      // Update projection display (keeping from script 1, but hidden)
      map.on('projection', () => {
        const currentProjection = map.getProjection().name;
        console.log('Current projection:', currentProjection);
      });
      
      // Add atmosphere/fog when globe is active (EXACTLY AS SCRIPT 1)
      map.on('load', () => {
        map.setFog({
          color: 'rgb(186, 210, 235)',
          'high-color': 'rgb(36, 92, 223)',
          'horizon-blend': 0.02,
          'space-color': 'rgb(11, 11, 25)',
          'star-intensity': 0.6
        });
        console.log('Map loaded successfully with custom style');
        
        // Add Almaty location markers after map loads
        addAlmatyMarkers();
      });

      // Show location popup after page loads (from script 3)
      setTimeout(() => {
        document.getElementById('locationPopup').classList.add('show');
      }, 1000);
    });

    // Add markers for Almaty locations
    function addAlmatyMarkers() {
      const locations = [
        { coords: [77.0515, 43.1630], name: 'Medeu', icon: '‚õ∏Ô∏è', desc: 'Mountain ice skating rink at 1,691m altitude' },
        { coords: [76.9770, 43.2300], name: 'Kok-Tobe', icon: 'üóº', desc: 'TV tower and observation deck - 1,100m' },
        { coords: [76.9565, 43.2582], name: 'Panfilov Park', icon: 'üèõÔ∏è', desc: 'Historic park with Zenkov Cathedral' },
        { coords: [76.9560, 43.2640], name: 'Green Bazaar', icon: 'üè™', desc: 'Traditional market since 1875' },
        { coords: [77.0808, 43.1281], name: 'Shymbulak', icon: '‚õ∑Ô∏è', desc: 'Ski resort - 2,200m altitude' }
      ];

      locations.forEach(loc => {
        const el = document.createElement('div');
        el.innerHTML = loc.icon;
        el.style.fontSize = '32px';
        el.style.cursor = 'pointer';

        new maptilersdk.Marker({ element: el })
          .setLngLat(loc.coords)
          .setPopup(new maptilersdk.Popup().setHTML(`<h3>${loc.icon} ${loc.name}</h3><p>${loc.desc}</p>`))
          .addTo(map);
      });

      // Add center marker for Almaty
      const centerEl = document.createElement('div');
      centerEl.innerHTML = 'üìç';
      centerEl.style.fontSize = '40px';
      centerEl.style.cursor = 'pointer';

      new maptilersdk.Marker({ element: centerEl })
        .setLngLat([76.9450, 43.2380])
        .setPopup(new maptilersdk.Popup().setHTML(`<h3>üèîÔ∏è Almaty City Center</h3><p>Kazakhstan's largest city with approximately 2 million people</p>`))
        .addTo(map);
    }

    // Fly to location (from script 2)
    function flyTo(coords, zoom) {
      map.flyTo({
        center: coords,
        zoom: zoom,
        duration: 2000,
        essential: true
      });
    }

    // Toggle sidebar (from script 2)
    function toggleUI() {
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('toggleBtn');
      
      sidebar.classList.toggle('hidden');
      toggleBtn.classList.toggle('sidebar-hidden');
      
      if (sidebar.classList.contains('hidden')) {
        toggleBtn.textContent = '‚ñ∂';
      } else {
        toggleBtn.textContent = '‚óÄ';
      }
    }

    // Transition button from red to green (from script 3)
    function transitionToGreen() {
      console.log('Starting transition to green...');
      const redPin = document.getElementById('redPin');
      const greenPin = document.getElementById('greenPin');
      
      let redOpacity = 1;
      let greenOpacity = 0;
      
      const transitionInterval = setInterval(() => {
        redOpacity -= 0.02;
        greenOpacity += 0.02;
        
        redPin.style.opacity = Math.max(0, redOpacity);
        greenPin.style.opacity = Math.min(1, greenOpacity);
        
        if (redOpacity <= 0) {
          clearInterval(transitionInterval);
          redPin.style.opacity = '0';
          greenPin.style.opacity = '1';
          console.log('Transition complete!');
        }
      }, 20);
    }

    // Get location using IP address (from script 3)
    async function getLocationByIP() {
      try {
        console.log('üåê Fetching location from ipwho.is...');
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch('https://ipwho.is/', {
          signal: controller.signal,
          headers: { 'Accept': 'application/json' }
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üìç API response:', data);
        
        if (!data.success) {
          throw new Error(`API error: ${data.message || 'Request failed'}`);
        }
        
        if (data.latitude && data.longitude && 
            !isNaN(data.latitude) && !isNaN(data.longitude) &&
            data.latitude >= -90 && data.latitude <= 90 &&
            data.longitude >= -180 && data.longitude <= 180) {
          
          locationPermissionGranted = true;
          console.log('‚úÖ Location found (IP-based):', data.city || 'Unknown', data.country || 'Unknown');
          console.log('üìå Coordinates:', data.latitude, data.longitude);
          console.log('üåç Full location data:', {
            ip: data.ip,
            city: data.city,
            region: data.region,
            country: data.country,
            postal: data.postal,
            timezone: data.timezone?.id,
            continent: data.continent
          });
          
          // Add marker for user location
          addUserMarker([data.longitude, data.latitude], data.city, data.country);
          
          // Fly to user location
          map.flyTo({
            center: [data.longitude, data.latitude],
            zoom: 10,
            duration: 3000
          });
          
          transitionToGreen();
          
          return {
            latitude: data.latitude,
            longitude: data.longitude,
            city: data.city,
            country: data.country,
            ip: data.ip
          };
        } else {
          throw new Error('Invalid coordinates received from API');
        }
      } catch (error) {
        console.error('‚ùå IP geolocation failed:', error.message);
        
        let errorMessage = "Could not determine your location.";
        
        if (error.name === 'AbortError') {
          errorMessage += "\n‚Ä¢ Request timed out - please check your internet connection";
        } else if (error.message.includes('Rate limited')) {
          errorMessage += "\n‚Ä¢ Too many requests - please try again in a few minutes";
        } else if (error.message.includes('blocked') || error.message.includes('CORS')) {
          errorMessage += "\n‚Ä¢ Service may be blocked by your network or browser";
        } else {
          errorMessage += "\n‚Ä¢ This might be due to ad blockers, VPN, or network restrictions";
        }
        
        alert(errorMessage);
        return null;
      }
    }

    // Add user location marker
    function addUserMarker(coords, city, country) {
      if (userMarker) {
        userMarker.remove();
      }

      const el = document.createElement('div');
      el.innerHTML = 'üìç';
      el.style.fontSize = '40px';
      el.style.cursor = 'pointer';

      userMarker = new maptilersdk.Marker({ element: el, color: '#00d4ff' })
        .setLngLat(coords)
        .setPopup(new maptilersdk.Popup().setHTML(`<h3>üìç Your Location</h3><p>${city}, ${country}</p>`))
        .addTo(map);
    }

    // Handle "Allow" button click (from script 3)
    async function handleLocationAllow() {
      console.log('üîç Location permission requested...');
      document.getElementById('locationPopup').classList.remove('show');
      
      if (!navigator.geolocation) {
        console.log('‚ö†Ô∏è Browser does not support geolocation, using IP fallback');
        await getLocationByIP();
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          locationPermissionGranted = true;
          const coords = [position.coords.longitude, position.coords.latitude];
          console.log('‚úÖ Location found (GPS):', coords);
          
          addUserMarker(coords, 'Your Location', '');
          map.flyTo({
            center: coords,
            zoom: 13,
            duration: 3000
          });
          
          transitionToGreen();
        },
        async (error) => {
          console.error('‚ö†Ô∏è GPS error:', error);
          
          let errorMsg = '';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg = "üö´ GPS access denied. Trying IP-based location...";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg = "üì° GPS unavailable. Using IP-based location instead...";
              break;
            case error.TIMEOUT:
              errorMsg = "‚è±Ô∏è GPS timeout. Falling back to IP-based location...";
              break;
            default:
              errorMsg = "‚ùó GPS error. Using IP-based location...";
          }
          
          console.log(errorMsg);
          await getLocationByIP();
        },
        {
          enableHighAccuracy: false,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }

    // Handle "Block" button click (from script 3)
    function handleLocationBlock() {
      console.log('Location permission blocked by user');
      document.getElementById('locationPopup').classList.remove('show');
      locationPermissionGranted = false;
    }
  </script>
</body>
</html>
